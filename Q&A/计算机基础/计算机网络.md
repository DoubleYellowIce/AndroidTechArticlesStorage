### 传输层

#### TCP

##### 三次握手

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e92d0ebc-7d46-413b-aec1-34a39602f787.png" width="600"/> </div><br>

- 关键字段

  - Seq。该字段为序列号。
  - SYN。该字段为同步字段，只会在第一，第二次握手时为1。
  - ACK。该字段为确认字段，根据规范，在建立连接后此字段都应该为1。
  - ack。该字段的作用是表明期待收到的序列号，从而告知另一端ack前面的序列都已经成功收到了。

- 三次握手可以改为两次握手吗？为什么？

  不可以，三次握手的目的是为了避免无效的连接请求到达服务器建立重复的连接。

  假设当客户端第一次给服务端发送连接请求报文，遇上了网络阻塞，该报文迟迟未能到达服务端，客户端在等待一定时长后，会选择重新发送连接请求报文，第二次发送的连接请求报文顺利到达服务端且顺利建立连接，此时第一次的连接请求报文也到达了服务端，服务端会给客户端发送连接请求的确认报文，在这种情况下

  - 如果只有两次握手，那么就会重复建立TCP连接。
  - 如果有三次握手，客户端会知道这是对失效连接请求报文的确认，可直接丢弃。

##### 四次挥手

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f87afe72-c2df-4c12-ac03-9b8d581a8af8.jpg" width="600"/> </div><br>

- 关键字段

  - FIN。该字段的作用是告诉另一端要释放TCP连接了。

- 四次挥手的原因？

  为了让服务端发送完还未发送的报文段。

- 为什么客户端TIME-WAIT阶段需要等待2MSL？

  等待的原因有两点

  - 防止服务端没有收到客户端的确认报文，又重新发送连接释放报文。
  - 让此次连接的报文都从网络中消失，确保下一次的连接不会出现此次连接的报文。

- MSL是什么？为什么等待时间是2MSL，不是1MSL，3MSL，100MSL？

  MSL全称为**Maximium Segment Lifetime**，是一个报文在网络中的最长存活时间，2MSL是报文来回所需要的最长时间，在2MSL中如果没有重新收到服务端的连接释放报文，就可以确认第四次挥手所发送的确认报文没有丢失。

##### 与UDP的区别

- UDP
  - 无连接，尽最大努力交付。
  - 面向报文，只对应用层传下来的报文添加首部变成数据报（datagram），不做任何处理。
  - 提供一对一，一对多，多对多的连接。
- TCP
  - 面向连接，有超时重传，流量控制，拥塞控制的机制来确保可靠传输。
  - 面向字节，将应用层传下来的报文看作字节流，分成大小不一的数据块。
  - 全双工通信。

#### 滑动窗口

上一个问题提到过TCP是面向字节的，需要注意的是，TCP面向字节并不等同于TCP是一个字节一个字节的发送，而是一个报文段一个报文段发送。

滑动窗口用来缓存字节流，在不同端滑动窗口缓存不同内容。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/a3253deb-8d21-40a1-aae4-7d178e4aa319.jpg" width="800"/> </div><br>

- 发送端

  滑动窗口缓存已经发送但还没有收到确认的，或还没发送的字节。

  维护时，滑动窗口会向右滑动直至窗口内第一个字节不是已发送已确认的状态。

- 接收端

  滑动窗口缓存已经确认但还没有上交主机，或还没发送确认报文的字节，需要注意的是，接收端只对最后一个有序到达的字节进行确认。

  维护时，滑动窗口会向右滑动直至窗口内第一个字节不是已确认已上交的状态。

常见问题

- 如何改变滑动窗口的大小

  TCP的报文首部有一个字段是接受方用来告诉发送方滑动窗口应该有多大。

- 存在意义

  - 流量控制，通过改变滑动窗口的大小可以改变发送方的发送速率，从而实现流量控制的目的。

#### 拥塞控制

- 与流量控制的区别。

  - 流量控制的目的是为了改变发送方的发送速率，来适应接受方的接收速率。
  - 拥塞控制格局更大，是为了避免网络拥塞。

- 为什么需要拥塞控制？

  当网络发生拥塞时，会更容易发生分段丢失的问题，由于超时重传的机制存在，发送方会重新发送分段，这会进一步加剧网络拥塞，而拥塞控制会抑制发送端的速率而减少网络拥塞。

- TCP如何实现拥塞控制？

  TCP主要通过慢开始，拥塞避免，快开始，快恢复四种算法实现拥塞控制，此外，发送方需要维护一个cwnd值，拥塞窗口大小。

  - 慢开始慢恢复

    <div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/910f613f-514f-4534-87dd-9b4699d59d31.png" width="800"/> </div><br>

    cwnd初始值为1，往后每轮次cwnd的值就会翻倍，直至cwnd等于ssthresh，此时进入拥塞避免阶段，往后每轮次cwnd都只加一，直至遇到网络阻塞，这时会进行如下操作。

    - 让ssthresh的值变成cwnd的一半。
    - cwnd变为1，这就是慢恢复的命名来源。

  - 快开始快重传

    接收端会对最后一个有序的报文段进行确认。

    当发送端收到接收端连续三次对某一个报文段的确认，就可以确认下一个报文段已经丢失，尽管此时网络有些阻塞，但还可以接受，只需要立刻重传下一个报文段，之后

    - 让ssthresh的值变成cwnd的一半。

    - 让cwnd变为ssthresh的值，这里直接进入了拥塞避免阶段。

- 为什么TCP需要进行分段？

  直接原因是为了让每次传送的数据大小不超过MSS（Maximum Segement Size），根本原因是为了避免网络层进行IP分片。

  - 当TCP没有进行分段时，可能会出现ip数据报(ip datagram)过大的情况，而传输层对一次性传输数据大小是有限制的，大小为MTU(Maximum Transmission Unit)，最大传输单元，像以太网的MTU为1500字节，为了让ip数据报大小不超过MTU，网络层会进行分片，而当网络层出现丢片的情况时候，TCP需要将全部数据进行重传，因为其不知道哪一片数据丢失了。
  - 当TCP进行分段的时候，网络层不会进行分片，当出现丢段的情况，TCP只需要重传丢失那一段即可，不需要重新重传全部数据。

- MSS的值是如何确定的？

  
  $$
  MSS=MTU-20Byte(标准ip首部大小)-20Byte(标准TCP首部大小)
  $$
  

### 应用层

#### DNS

- DNS是基于什么传输层协议上的，为什么？

  DNS是基于Udp的，原因有如下三点

  - DNS响应报文通常比较小，即使在传输过程发生丢失，重传的代价也是可以接受的。
  - 尽管Tcp是可靠传输，但由于三次握手，四次挥手的建立连接或释放连接过程的存在，有一定的延迟。

  - Tcp需要建立连接，一个DNS服务器往往是服务一大片区域的，我国属于是面积辽阔，网民众多的国家，根域名服务器也只有26台，如果DNS采用Tcp，维护这么多连接，这对DNS服务器的压力是难以想象。

- Udp是不可靠传输，那么DNS是一个不可靠的应用层协议吗？

  不是的，DNS在应用层实现了超时重传的可靠传输。

- DNS只使用Udp吗？

  不是的，在下列两种情况，DNS会使用Tcp。

  - 响应报文超过512字节。这是因为Udp响应报文最大为512字节。
  - 区域传送。区域传送会在主域名服务器给辅助域名服务器传送变化的部分。

#### FTP

FTP有两个连接，控制连接和数据连接。

- 控制连接

  服务端开放端口号21，由客户端主动建立连接，客户端利用这个连接发送命令给服务端，并接收服务端的响应。

- 数据连接

  数据连接是用于数据传送，根据服务端是否主动建立连接分为主动模式和被动模式。

  - 主动模式。

    服务端端口号为20，客户端端口号任意，但必须大于等于1024，因为0～1023为熟知端口号。

    该模式的缺点是客户端必须开发端口号给服务端，需要配置防火墙。

  - 被动模式。

    客户端指定任意端口号，服务端端口号任意。

    该模式的缺点是服务端会暴露太多的端口号，有一定的安全隐患。

### 参考资料

1. [计算机网络](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E7%9B%AE%E5%BD%95.md)
2. [根域名服务器只有13台？](https://zhuanlan.zhihu.com/p/107492241)
2. [What is a Firewall?](https://www.youtube.com/watch?v=kDEX1HXybrU&ab_channel=PowerCertAnimatedVideos)
2. [什么情况下TCP传输会出现ip分片？](https://www.zhihu.com/question/489085702)
2. [TCP滑动窗口](https://www.cnblogs.com/alifpga/p/7675850.html)
2. [What's the difference between a TCP segment and a TCP packet?](https://superuser.com/questions/298087/whats-the-difference-between-a-tcp-segment-and-a-tcp-packet)
2. [报文、报文段、分组、包、数据报、帧、数据流的概念区别](https://blog.csdn.net/a3192048/article/details/84671340)

